<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIä»£ç†æœåŠ¡å™¨ - ç»Ÿè®¡é¢æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="with-navbar">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <div class="navbar-logo">P</div>
                <span class="navbar-title">API Proxy</span>
            </a>
            <div class="navbar-nav">
                <a href="/" class="nav-item active">
                    <span>ğŸ“Š</span>
                    <span>ç»Ÿè®¡æ¦‚è§ˆ</span>
                </a>
                <a href="/admin" class="nav-item">
                    <span>ğŸ”§</span>
                    <span>æ˜ å°„ç®¡ç†</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ğŸš€ APIä»£ç†æœåŠ¡å™¨<span class="go-badge">Goç‰ˆæœ¬</span><span class="performance-badge">æ€§èƒ½ä¼˜åŒ–</span></h1>
            <p id="performance-info">æ­£åœ¨åŠ è½½æ€§èƒ½æ•°æ®...</p>
        </div>
        
        <div class="chart-section">
            <div class="chart-header">
                <h2 class="chart-title">ğŸ“Š APIè°ƒç”¨ç»Ÿè®¡å›¾è¡¨</h2>
                <div class="time-tabs">
                    <button class="time-tab active" data-period="today">24å°æ—¶</button>
                    <button class="time-tab" data-period="week">7å¤©</button>
                    <button class="time-tab" data-period="month">30å¤©</button>
                    <button class="time-tab" data-period="total">æ€»è®¡</button>
                </div>
            </div>
            <div class="chart-info">
                <p>ğŸ“Š ç»„åˆå›¾è¡¨ï¼šè“è‰²æŸ±çŠ¶å›¾æ˜¾ç¤ºæ€»APIè°ƒç”¨æ¬¡æ•°ï¼Œçº¢è‰²æŠ˜çº¿å›¾æ˜¾ç¤ºæ€»ä½“è°ƒç”¨è¶‹åŠ¿ã€‚é€‰æ‹©ä¸Šæ–¹æ—¶é—´èŒƒå›´æŸ¥çœ‹ä¸åŒç»´åº¦æ•°æ®ã€‚</p>
            </div>
            <div class="chart-grid">
                <div class="chart-container">
                    <canvas id="apiChart"></canvas>
                </div>
                <div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>
            </div>
        </div>
        
        <div class="stats-grid" id="stats-grid">
            <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
        
        <div class="usage-guide">
            <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <h3>æ”¯æŒçš„APIç«¯ç‚¹</h3>
            <div class="endpoint-list" id="endpoint-list">
                <!-- ç«¯ç‚¹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <div class="example-section">
                <h3>ğŸ”§ ä½¿ç”¨æ–¹æ³•</h3>
                <p style="margin-bottom: 16px; color: #666;">å°†åŸå§‹APIåœ°å€æ›¿æ¢ä¸ºä»£ç†åœ°å€ï¼Œä¾‹å¦‚ï¼š</p>
                
                <h4 style="margin: 16px 0 8px 0; color: #333;">OpenAI API ç¤ºä¾‹ï¼š</h4>
                <div class="code-block"># åŸå§‹åœ°å€
https://api.openai.com/v1/chat/completions

# ä»£ç†åœ°å€
<span id="current-domain">loading...</span>/openai/v1/chat/completions</div>
                
                <h4 style="margin: 16px 0 8px 0; color: #333;">JavaScript ç¤ºä¾‹ï¼š</h4>
                <div class="code-block">// ä½¿ç”¨ fetch API
const response = await fetch('<span id="js-example-domain">loading...</span>/openai/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_API_KEY'
  },
  body: JSON.stringify({
    model: 'gpt-3.5-turbo',
    messages: [{ role: 'user', content: 'Hello!' }]
  })
});

const data = await response.json();
console.log(data);</div>
                
                <h4 style="margin: 16px 0 8px 0; color: #333;">Gemini API ç¤ºä¾‹ï¼š</h4>
                <div class="code-block"># åŸå§‹åœ°å€
https://generativelanguage.googleapis.com/v1/models

# ä»£ç†åœ°å€
<span id="gemini-example-domain">loading...</span>/gemini/v1/models</div>
                
                <h4 style="margin: 16px 0 8px 0; color: #333;">Claude API ç¤ºä¾‹ï¼š</h4>
                <div class="code-block"># åŸå§‹åœ°å€
https://api.anthropic.com/v1/messages

# ä»£ç†åœ°å€
<span id="claude-example-domain">loading...</span>/claude/v1/messages</div>
            </div>
            
            <div class="example-section">
                <h3>âš¡ Goç‰ˆæœ¬ç‰¹æ€§</h3>
                <ul style="margin-left: 20px; color: #666; line-height: 1.6;">
                    <li>ğŸš€ <strong>é«˜å¹¶å‘æ€§èƒ½</strong>ï¼šæ”¯æŒæ•°ä¸‡å¹¶å‘è¿æ¥</li>
                    <li>âš¡ <strong>ä½å»¶è¿Ÿ</strong>ï¼šå¹³å‡å“åº”æ—¶é—´ < 50ms</li>
                    <li>ğŸ’¾ <strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šä½¿ç”¨åŸå­æ“ä½œå’Œè¯»å†™é”</li>
                    <li>ğŸ”„ <strong>è¿æ¥æ± </strong>ï¼šHTTPè¿æ¥å¤ç”¨å’ŒKeep-Alive</li>
                    <li>ğŸ“Š <strong>æ™ºèƒ½ç¼“å­˜</strong>ï¼šç»Ÿè®¡æ•°æ®3ç§’ç¼“å­˜æœºåˆ¶</li>
                    <li>ğŸ›¡ï¸ <strong>å¼‚æ­¥å¤„ç†</strong>ï¼šç»Ÿè®¡è®°å½•å¼‚æ­¥åŒ–é¿å…é˜»å¡</li>
                    <li>ğŸ§¹ <strong>è‡ªåŠ¨æ¸…ç†</strong>ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®é‡Šæ”¾å†…å­˜</li>
                    <li>âœ… æ”¯æŒæ‰€æœ‰HTTPæ–¹æ³•å’ŒCORSè·¨åŸŸè¯·æ±‚</li>
                    <li>âœ… å®æ—¶æ€§èƒ½ç›‘æ§å’Œé”™è¯¯ç‡ç»Ÿè®¡</li>
                    <li>âœ… ä»£ç†æ¨¡å¼æ”¯æŒå®Œæ•´ç½‘é¡µæµè§ˆ</li>
                    <li>âœ… Gemini NoThinkæ¨¡å¼è‡ªåŠ¨ç¦ç”¨æ€è€ƒæ¨¡å¼</li>
                </ul>
            </div>
            
            <div class="example-section">
                <h3>âš¡ ç‰¹æ€§</h3>
                <ul style="margin-left: 20px; color: #666; line-height: 1.6;">
                    <li>âœ… æ”¯æŒæ‰€æœ‰HTTPæ–¹æ³• (GET, POST, PUT, DELETEç­‰)</li>
                    <li>âœ… è‡ªåŠ¨è½¬å‘è¯·æ±‚å¤´å’Œå“åº”å¤´</li>
                    <li>âœ… æ”¯æŒCORSè·¨åŸŸè¯·æ±‚</li>
                    <li>âœ… å®æ—¶ç»Ÿè®¡APIè°ƒç”¨æ¬¡æ•°</li>
                    <li>âœ… ä»£ç†æ¨¡å¼æ”¯æŒå®Œæ•´ç½‘é¡µæµè§ˆ</li>
                    <li>âœ… è‡ªåŠ¨è·å–å½“å‰åŸŸåï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®</li>
                    <li>âœ… ç»„åˆå›¾è¡¨å±•ç¤ºè°ƒç”¨ç»Ÿè®¡å’Œè¶‹åŠ¿</li>
                    <li>âœ… Gemini NoThinkæ¨¡å¼ï¼šè‡ªåŠ¨ä¸ºGeminiè¯·æ±‚æ·»åŠ thinkingBudget: 0ç¦ç”¨æ€è€ƒæ¨¡å¼</li>
                </ul>
            </div>
            
            <div class="example-section">
                <h3>ğŸ“Š ç»Ÿè®¡åŠŸèƒ½</h3>
                <ul style="margin-left: 20px; color: #666; line-height: 1.6;">
                    <li>ğŸ“ˆ å®æ—¶ç»Ÿè®¡APIè°ƒç”¨æ¬¡æ•°</li>
                    <li>ğŸ“ˆ æ”¯æŒå¤šæ—¶é—´ç»´åº¦ç»Ÿè®¡ï¼ˆ24h/7d/30d/æ€»è®¡ï¼‰</li>
                    <li>ğŸ“ˆ é‡ç‚¹ç›‘æ§OpenAIã€Geminiã€Claudeå’ŒXAI APIä½¿ç”¨é‡</li>
                    <li>ğŸ“ˆ æä¾›JSONæ ¼å¼ç»Ÿè®¡API: <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;" id="stats-api-url">loading...</code></li>
                    <li>ğŸ“ˆ ç»„åˆå›¾è¡¨å±•ç¤ºï¼ŒæŸ±çŠ¶å›¾+æŠ˜çº¿å›¾æ˜¾ç¤ºæ•°æ®å’Œè¶‹åŠ¿</li>
                </ul>
            </div>
            
            <div class="example-section">
                <h3>ğŸ“Š ç»Ÿè®¡API</h3>
                <p style="margin-bottom: 16px; color: #666;">æä¾›JSONæ ¼å¼çš„ç»Ÿè®¡æ•°æ®ï¼š</p>
                <div class="code-block">GET <span id="stats-example-domain">loading...</span>/stats</div>
            </div>
        </div>
    </div>
    <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
    
    <div id="toast" class="toast"></div>
    
    <script>
        let rawStatsData = null;
        let chartInstance = null;
        let currentPeriod = 'today';
        let currentDomain = '';
        const barColors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#64748b', '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#3b82f6'];

        // APIæ˜ å°„
        const apiMapping = {
            "/discord": "https://discord.com/api",
            "/telegram": "https://api.telegram.org",
            "/openai": "https://api.openai.com",
            "/claude": "https://api.anthropic.com",
            "/gemini": "https://generativelanguage.googleapis.com",
            "/gnothink": "https://generativelanguage.googleapis.com",
            "/meta": "https://www.meta.ai/api",
            "/groq": "https://api.groq.com/openai",
            "/xai": "https://api.x.ai",
            "/cohere": "https://api.cohere.ai",
            "/huggingface": "https://api-inference.huggingface.co",
            "/together": "https://api.together.xyz",
            "/novita": "https://api.novita.ai",
            "/portkey": "https://api.portkey.ai",
            "/fireworks": "https://api.fireworks.ai",
            "/openrouter": "https://openrouter.ai/api",
            "/sophnet": "https://sophnet.com/",
            "/cerebras": "https://api.cerebras.ai"
        };

        // è·å–å½“å‰åŸŸå
        function getCurrentDomain() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            return `${protocol}//${host}`;
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatsData() {
            try {
                const response = await fetch('/stats');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                rawStatsData = {
                    stats: {
                        total: data.total,
                        endpoints: data.endpoints
                    },
                    performance: data.performance,
                    requests: data.requests || [], // ä»åç«¯è·å–çš„è¯·æ±‚æ—¶é—´æˆ³æ•°æ®
                    endpoints: data.endpoints
                };
                
                return data;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                return null;
            }
        }

        // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
        function renderStatsCards(data) {
            const getStats = (endpoint) => {
                if (data.endpoints && data.endpoints[endpoint]) {
                    return data.endpoints[endpoint];
                }
                return { total: 0, today: 0, week: 0, month: 0 };
            };

            const cerebrasStats = getStats('/cerebras');
            const geminiStats = getStats('/gemini');
            const claudeStats = getStats('/claude');
            const xaiStats = getStats('/xai');

            const activeEndpoints = Object.keys(data.endpoints || {}).filter(k => 
                data.endpoints[k].total > 0
            ).length;

            // æ€§èƒ½ç­‰çº§CSSç±»
            const getPerformanceClass = (value, good, warning) => {
                if (value <= good) return 'good';
                if (value <= warning) return 'warning';
                return 'danger';
            };

            const getMemoryClass = (value) => {
                if (value <= 50) return 'good';
                if (value <= 100) return 'warning';
                return 'danger';
            };

            const getResponseTimeClass = (value) => {
                if (value <= 100) return 'good';
                if (value <= 500) return 'warning';
                return 'danger';
            };

            const getErrorRateClass = (value) => {
                if (value <= 1.0) return 'good';
                if (value <= 5.0) return 'warning';
                return 'danger';
            };

            const performance = data.performance || {};
            const qpsClass = getPerformanceClass(performance.requests_per_sec || 0, 10, 50);
            const responseTimeClass = getResponseTimeClass(performance.avg_response_time_ms || 0);
            const errorRateClass = getErrorRateClass(performance.error_rate || 0);
            const memoryClass = getMemoryClass(performance.memory_usage_mb || 0);

            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card">
                    <h3><div class="api-icon openai-icon">C</div>Cerebras API è°ƒç”¨ç»Ÿè®¡</h3>
                    <div class="stat-row"><span class="stat-label">24å°æ—¶</span><span class="stat-value">${cerebrasStats.today}</span></div>
                    <div class="stat-row"><span class="stat-label">7å¤©</span><span class="stat-value">${cerebrasStats.week}</span></div>
                    <div class="stat-row"><span class="stat-label">30å¤©</span><span class="stat-value">${cerebrasStats.month}</span></div>
                    <div class="stat-row"><span class="stat-label">æ€»è®¡</span><span class="stat-value">${cerebrasStats.total}</span></div>
                </div>
                <div class="stat-card">
                    <h3><div class="api-icon gemini-icon">G</div>Gemini API è°ƒç”¨ç»Ÿè®¡</h3>
                    <div class="stat-row"><span class="stat-label">24å°æ—¶</span><span class="stat-value">${geminiStats.today}</span></div>
                    <div class="stat-row"><span class="stat-label">7å¤©</span><span class="stat-value">${geminiStats.week}</span></div>
                    <div class="stat-row"><span class="stat-label">30å¤©</span><span class="stat-value">${geminiStats.month}</span></div>
                    <div class="stat-row"><span class="stat-label">æ€»è®¡</span><span class="stat-value">${geminiStats.total}</span></div>
                </div>
                <div class="stat-card">
                    <h3><div class="api-icon claude-icon">C</div>Claude API è°ƒç”¨ç»Ÿè®¡</h3>
                    <div class="stat-row"><span class="stat-label">24å°æ—¶</span><span class="stat-value">${claudeStats.today}</span></div>
                    <div class="stat-row"><span class="stat-label">7å¤©</span><span class="stat-value">${claudeStats.week}</span></div>
                    <div class="stat-row"><span class="stat-label">30å¤©</span><span class="stat-value">${claudeStats.month}</span></div>
                    <div class="stat-row"><span class="stat-label">æ€»è®¡</span><span class="stat-value">${claudeStats.total}</span></div>
                </div>
                <div class="stat-card">
                    <h3><div class="api-icon xai-icon">X</div>XAI API è°ƒç”¨ç»Ÿè®¡</h3>
                    <div class="stat-row"><span class="stat-label">24å°æ—¶</span><span class="stat-value">${xaiStats.today}</span></div>
                    <div class="stat-row"><span class="stat-label">7å¤©</span><span class="stat-value">${xaiStats.week}</span></div>
                    <div class="stat-row"><span class="stat-label">30å¤©</span><span class="stat-value">${xaiStats.month}</span></div>
                    <div class="stat-row"><span class="stat-label">æ€»è®¡</span><span class="stat-value">${xaiStats.total}</span></div>
                </div>
                <div class="stat-card">
                    <h3><div class="api-icon total-icon">ğŸ“Š</div>æ€»ä½“ç»Ÿè®¡</h3>
                    <div class="stat-row"><span class="stat-label">æ€»è¯·æ±‚æ•°</span><span class="stat-value">${data.total || 0}</span></div>
                    <div class="stat-row"><span class="stat-label">æ´»è·ƒç«¯ç‚¹</span><span class="stat-value">${activeEndpoints}</span></div>
                    <div class="stat-row"><span class="stat-label">æœåŠ¡çŠ¶æ€</span><span class="stat-value good">ğŸŸ¢ è¿è¡Œä¸­ (Goä¼˜åŒ–ç‰ˆ)</span></div>
                </div>
                <div class="stat-card">
                    <h3><div class="api-icon perf-icon">âš¡</div>å®æ—¶æ€§èƒ½æŒ‡æ ‡</h3>
                    <div class="stat-row"><span class="stat-label">æ¯ç§’è¯·æ±‚æ•°</span><span class="stat-value ${qpsClass}">${(performance.requests_per_sec || 0).toFixed(2)} QPS</span></div>
                    <div class="stat-row"><span class="stat-label">å¹³å‡å“åº”æ—¶é—´</span><span class="stat-value ${responseTimeClass}">${performance.avg_response_time_ms || 0} ms</span></div>
                    <div class="stat-row"><span class="stat-label">é”™è¯¯ç‡</span><span class="stat-value ${errorRateClass}">${(performance.error_rate || 0).toFixed(2)}%</span></div>
                    <div class="stat-row"><span class="stat-label">å†…å­˜ä½¿ç”¨</span><span class="stat-value ${memoryClass}">${(performance.memory_usage_mb || 0).toFixed(2)} MB</span></div>
                    <div class="stat-row"><span class="stat-label">åç¨‹æ•°é‡</span><span class="stat-value">${performance.goroutine_count || 0}</span></div>
                </div>
            `;
        }

        // æ¸²æŸ“ç«¯ç‚¹åˆ—è¡¨
        function renderEndpointList() {
            let endpointListHTML = '';
            for (const endpoint in apiMapping) {
                endpointListHTML += `<div class="endpoint-item" title="ç‚¹å‡»å¤åˆ¶å®Œæ•´åœ°å€">
                    <div class="endpoint-path">${endpoint}</div>
                    <div class="endpoint-url">${currentDomain}${endpoint}</div>
                </div>`;
            }
            document.getElementById('endpoint-list').innerHTML = endpointListHTML;

            // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
            document.querySelectorAll('.endpoint-item').forEach(item => {
                item.addEventListener('click', function() {
                    const url = this.querySelector('.endpoint-url').textContent.trim();
                    copyToClipboard(url);
                    const originalBg = this.style.backgroundColor;
                    const originalBorder = this.style.borderLeftColor;
                    this.style.backgroundColor = '#dcfce7';
                    this.style.borderLeftColor = '#16a34a';
                    setTimeout(() => {
                        this.style.backgroundColor = originalBg;
                        this.style.borderLeftColor = originalBorder;
                    }, 1000);
                });
            });
        }

        // æ›´æ–°æ€§èƒ½ä¿¡æ¯
        function updatePerformanceInfo(performance) {
            const qps = (performance.requests_per_sec || 0).toFixed(2);
            const memory = (performance.memory_usage_mb || 0).toFixed(2);
            const info = `é«˜æ€§èƒ½å®æ—¶ç»Ÿè®¡ä¸ä½¿ç”¨æŒ‡å— - QPS: ${qps} | å¹³å‡å“åº”: ${performance.avg_response_time_ms || 0}ms | å†…å­˜: ${memory}MB`;
            document.getElementById('performance-info').textContent = info;
        }

        // æ›´æ–°åŸŸåç›¸å…³çš„æ˜¾ç¤º
        function updateDomainReferences() {
            document.getElementById('current-domain').textContent = currentDomain;
            document.getElementById('js-example-domain').textContent = currentDomain;
            document.getElementById('gemini-example-domain').textContent = currentDomain;
            document.getElementById('claude-example-domain').textContent = currentDomain;
            document.getElementById('stats-api-url').textContent = `${currentDomain}/stats`;
            document.getElementById('stats-example-domain').textContent = currentDomain;
        }

        // å›¾è¡¨ç›¸å…³å‡½æ•°
        function getChartDataForPeriod(period, allRequests, endpointDetails) {
            const now = Date.now();
            let labels = [];
            let aggregatedData = [];

            if (period === 'today') {
                const hourlyCounts = Array(24).fill(0);
                const firstHourTimestamp = new Date(now - 23 * 60 * 60 * 1000);
                firstHourTimestamp.setMinutes(0, 0, 0);

                for (let i = 0; i < 24; i++) {
                    const hour = new Date(firstHourTimestamp);
                    hour.setHours(firstHourTimestamp.getHours() + i);
                    labels.push(hour.getHours().toString().padStart(2, '0') + ':00');
                }

                const twentyFourHoursAgo = now - 24 * 60 * 60 * 1000;
                allRequests.filter(req => (req.timestamp * 1000) >= twentyFourHoursAgo)
                    .forEach(req => {
                        const reqHour = new Date(req.timestamp * 1000);
                        const diffHours = Math.floor((reqHour.getTime() - firstHourTimestamp.getTime()) / (60 * 60 * 1000));
                        if (diffHours >= 0 && diffHours < 24) {
                            hourlyCounts[diffHours]++;
                        }
                    });
                aggregatedData = hourlyCounts;
            } else if (period === 'week' || period === 'month') {
                const numDays = period === 'week' ? 7 : 30;
                const dailyCounts = Array(numDays).fill(0);
                const firstDayTimestamp = new Date(now);
                firstDayTimestamp.setDate(firstDayTimestamp.getDate() - (numDays - 1));
                firstDayTimestamp.setHours(0, 0, 0, 0);

                for (let i = 0; i < numDays; i++) {
                    const day = new Date(firstDayTimestamp);
                    day.setDate(firstDayTimestamp.getDate() + i);
                    labels.push(day.getFullYear() + '-' + (day.getMonth() + 1).toString().padStart(2, '0') + '-' + day.getDate().toString().padStart(2, '0'));
                }
                
                const periodStartTimestamp = firstDayTimestamp.getTime();
                allRequests.filter(req => (req.timestamp * 1000) >= periodStartTimestamp)
                    .forEach(req => {
                        const reqDay = new Date(req.timestamp * 1000);
                        reqDay.setHours(0,0,0,0);
                        const diffDays = Math.floor((reqDay.getTime() - firstDayTimestamp.getTime()) / (24 * 60 * 60 * 1000));
                        if (diffDays >= 0 && diffDays < numDays) {
                           dailyCounts[diffDays]++;
                        }
                    });
                aggregatedData = dailyCounts;
            } else if (period === 'total') {
                const activeEndpoints = Object.keys(endpointDetails).filter(ep => endpointDetails[ep].total > 0);
                labels = activeEndpoints.map(ep => ep.replace('/', ''));
                aggregatedData = activeEndpoints.map(ep => endpointDetails[ep].total);
            }
            return { labels, data: aggregatedData };
        }

        function createCombinedChart(period) {
            const ctx = document.getElementById('apiChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            const chartData = getChartDataForPeriod(period, rawStatsData.requests || [], rawStatsData.endpoints || {});

            if (chartData.labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = '#64748b';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                updateLegend(period, { labels: [], barData: [] });
                return;
            }
            
            const xAxisTitle = period === 'total' ? 'API ç«¯ç‚¹' : (period === 'today' ? 'å°æ—¶ (è¿‡å»24å°æ—¶)' : 'æ—¥æœŸ');

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'APIè°ƒç”¨æ¬¡æ•°',
                            data: chartData.data,
                            backgroundColor: period === 'total' 
                                ? chartData.labels.map((_, i) => barColors[i % barColors.length] + 'B3')
                                : '#6366f1B3',
                            borderColor: period === 'total' 
                                ? chartData.labels.map((_, i) => barColors[i % barColors.length])
                                : '#6366f1',
                            borderWidth: 1.5,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'è°ƒç”¨è¶‹åŠ¿',
                            data: chartData.data,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2.5,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1.5,
                            pointRadius: period === 'total' ? 4 : (period === 'today' ? 3 : 4),
                            pointHoverRadius: period === 'total' ? 6 : (period === 'today' ? 5 : 6),
                            fill: false,
                            tension: (period === 'today' || period === 'total') ? 0.1 : 0.3,
                            yAxisID: 'y',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20, font: { size: 12 } } },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.85)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: '#6366f1',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y + ' æ¬¡';
                                    
                                    if (period === 'total') {
                                        const total = chartData.data.reduce((a, b) => a + b, 0);
                                        if (total > 0) {
                                            const percentage = ((context.raw / total) * 100).toFixed(1);
                                            label += ' (' + percentage + '%)';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: xAxisTitle, color: '#333', font: { weight: 'bold' } },
                            ticks: { color: '#64748b', maxRotation: period === 'month' ? 45 : 0, minRotation: 0 },
                            grid: { color: '#e2e8f0' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#64748b', precision: 0 },
                            grid: { color: '#e2e8f0' },
                            title: { display: true, text: 'è°ƒç”¨æ¬¡æ•°', color: '#333', font: { weight: 'bold' } }
                        }
                    },
                    animation: { duration: 800, easing: 'easeOutQuart' }
                }
            };
            chartInstance = new Chart(ctx, chartConfig);
            updateLegend(period, chartData);
        }

        function updateLegend(period, chartData) {
            const legendContainer = document.getElementById('chartLegend');
            legendContainer.innerHTML = '';

            if (chartData.labels.length === 0) {
                legendContainer.innerHTML = '<div class="no-data">æœŸé—´å†…æ— è°ƒç”¨æ•°æ®</div>';
                return;
            }

            if (period === 'total') {
                const totalOverall = chartData.data.reduce((sum, item) => sum + item, 0);
                const legendItemsHtml = chartData.labels.map((label, index) => {
                    const value = chartData.data[index];
                    const percentage = totalOverall > 0 ? ((value / totalOverall) * 100).toFixed(1) : 0;
                    return '<div class="legend-item">' +
                        '<div class="legend-color" style="background-color: ' + barColors[index % barColors.length] + '"></div>' +
                        '<span>' + label + ': ' + value + ' æ¬¡ (' + percentage + '%)</span>' +
                        '</div>';
                }).join('');
                legendContainer.innerHTML = legendItemsHtml;
            } else {
                const periodText = period === 'today' ? '24å°æ—¶' : (period === 'week' ? '7å¤©' : '30å¤©');
                legendContainer.innerHTML = 
                    '<div class="legend-item">' +
                        '<div class="legend-color" style="background-color: #6366f1"></div>' +
                        '<span>æ€»è°ƒç”¨æ¬¡æ•° (æŸ±çŠ¶)</span>' +
                    '</div>' +
                    '<div class="legend-item">' +
                        '<div class="legend-line" style="background-color: #ef4444"></div>' +
                        '<span>è°ƒç”¨è¶‹åŠ¿ (æŠ˜çº¿)</span>' +
                    '</div>' +
                    '<p style="font-size: 0.85rem; color: #666; margin-top: 10px;">' +
                        'æ˜¾ç¤ºè¿‡å» ' + periodText + ' çš„æ€»è°ƒç”¨æ•°æ®ã€‚' +
                    '</p>';
            }
        }

        function switchPeriod(newPeriod) {
            currentPeriod = newPeriod;
            document.querySelectorAll('.time-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('[data-period="' + newPeriod + '"]').classList.add('active');
            createCombinedChart(currentPeriod);
        }

        // å·¥å…·å‡½æ•°
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å·²å¤åˆ¶: ' + text);
                }, () => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶: ' + text);
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥');
            }
            document.body.removeChild(ta);
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const data = await loadStatsData();
            if (data) {
                renderStatsCards(data);
                updatePerformanceInfo(data.performance);
                createCombinedChart(currentPeriod);
                showToast('æ•°æ®å·²åˆ·æ–°');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            currentDomain = getCurrentDomain();
            updateDomainReferences();
            renderEndpointList();
            
            const data = await loadStatsData();
            if (data) {
                renderStatsCards(data);
                updatePerformanceInfo(data.performance);
                createCombinedChart(currentPeriod);
            }

            // æ—¶é—´åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.time-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchPeriod(this.dataset.period);
                });
            });
        });

        // å®šæ—¶åˆ·æ–°
        setInterval(refreshData, 60000);
    </script>
</body>
</html>
