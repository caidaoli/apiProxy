<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ˜ å°„ç®¡ç† - ç®¡ç†é¢æ¿</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f7ff',
                            100: '#ebf0ff',
                            500: '#667eea',
                            600: '#5a67d8',
                            700: '#4c51bf',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .toast.show {
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-purple-600 min-h-screen">
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginPage" class="flex justify-center items-center min-h-screen p-5">
        <div class="bg-white rounded-2xl shadow-2xl p-10 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">ğŸ”</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ç®¡ç†å‘˜ç™»å½•</h1>
                <p class="text-gray-600">è¯·è¾“å…¥ç®¡ç†ä»¤ç‰Œä»¥è®¿é—®APIæ˜ å°„ç®¡ç†é¢æ¿</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label for="tokenInput" class="block text-sm font-semibold text-gray-700 mb-2">
                        ç®¡ç†ä»¤ç‰Œ (ADMIN_TOKEN)
                    </label>
                    <input
                        type="password"
                        id="tokenInput"
                        placeholder="è¯·è¾“å…¥ç®¡ç†ä»¤ç‰Œ"
                        required
                        autocomplete="off"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-colors"
                    >
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200">
                    ç™»å½•
                </button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="adminPanel" class="hidden">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="navbar-container">
                <a href="/" class="navbar-brand">
                    <div class="navbar-logo">P</div>
                    <span class="navbar-title">API Proxy</span>
                </a>
                <div class="navbar-nav">
                    <a href="/" class="nav-item">
                        <span>ğŸ“Š</span>
                        <span>ç»Ÿè®¡æ¦‚è§ˆ</span>
                    </a>
                    <a href="/admin" class="nav-item active">
                        <span>ğŸ”§</span>
                        <span>æ˜ å°„ç®¡ç†</span>
                    </a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-5">
            <!-- å¤´éƒ¨æ ‡é¢˜åŒºåŸŸ -->
            <div class="bg-white rounded-2xl shadow-md p-8 mb-5">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">APIæ˜ å°„ç®¡ç†</h1>
                        <p class="text-base text-gray-600">ç®¡ç†ç”¨äº API (/v1/*) è®¿é—®çš„æ˜ å°„</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="showAddModal()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 shadow-sm">
                            <span>+</span>
                            <span>åˆ›å»ºæ˜ å°„</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å·¥å…·æ  -->
            <div class="bg-white rounded-2xl shadow-md mb-5">
                <div class="p-5">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex gap-3 w-full md:w-auto flex-wrap">
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="ğŸ” æœç´¢å‰ç¼€æˆ–URL..."
                                oninput="filterMappings()"
                                class="flex-1 md:w-80 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm"
                            >
                            <button onclick="loadMappings()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition-colors flex items-center gap-2">
                                <span>ğŸ”„</span>
                                <span class="hidden sm:inline">åˆ·æ–°</span>
                            </button>
                            <button
                                id="batchDeleteBtn"
                                onclick="batchDeleteMappings()"
                                class="hidden px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
                                <span>åˆ é™¤é€‰ä¸­ (<span id="selectedCount">0</span>)</span>
                            </button>
                        </div>
                        <div class="flex gap-3 items-center text-sm text-gray-600">
                            <span id="statsInfo">åŠ è½½ä¸­...</span>
                            <button onclick="logout()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition-colors text-sm">
                                é€€å‡º
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¡¨æ ¼å®¹å™¨ -->
            <div class="bg-white rounded-2xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3.5 text-left w-12">
                                    <input
                                        type="checkbox"
                                        id="selectAll"
                                        onchange="toggleSelectAll()"
                                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                    >
                                </th>
                                <th class="px-6 py-3.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    å‰ç¼€è·¯å¾„
                                </th>
                                <th class="px-6 py-3.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ç›®æ ‡URL
                                </th>
                                <th class="px-6 py-3.5 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                    æ“ä½œ
                                </th>
                            </tr>
                        </thead>
                        <tbody id="mappingsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-16 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <div class="text-5xl mb-3">ğŸ“¦</div>
                                        <div class="text-base font-medium text-gray-600">åŠ è½½ä¸­...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="mappingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-5" onclick="handleModalClick(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all" onclick="event.stopPropagation()">
            <div class="p-8">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-6">æ·»åŠ APIæ˜ å°„</h2>
                <form onsubmit="handleSaveMapping(event)" class="space-y-5">
                    <div>
                        <label for="prefixInput" class="block text-sm font-medium text-gray-700 mb-2">
                            å‰ç¼€è·¯å¾„ <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="prefixInput"
                            placeholder="/openai"
                            required
                            pattern="^/[a-zA-Z0-9_-]+$"
                            title="å¿…é¡»ä»¥/å¼€å¤´,åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors font-mono text-sm"
                        >
                        <p class="mt-1.5 text-xs text-gray-500">ç¤ºä¾‹: /openai, /claude, /gemini</p>
                    </div>
                    <div>
                        <label for="targetInput" class="block text-sm font-medium text-gray-700 mb-2">
                            ç›®æ ‡URL <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="url"
                            id="targetInput"
                            placeholder="https://api.openai.com"
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors text-sm"
                        >
                        <p class="mt-1.5 text-xs text-gray-500">å®Œæ•´çš„APIç«¯ç‚¹URL</p>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 px-6 py-2.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="flex-1 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors shadow-sm">
                            ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toasté€šçŸ¥ -->
    <div id="toast" class="hidden fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-2xl text-white font-medium z-50 max-w-md"></div>

    <script>
        let adminToken = '';
        let allMappings = {};
        let isEditMode = false;
        let editingPrefix = '';
        let selectedPrefixes = new Set();

        // ç™»å½•å¤„ç†
        async function handleLogin(event) {
            event.preventDefault();
            const token = document.getElementById('tokenInput').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (response.ok) {
                    adminToken = token;
                    localStorage.setItem('adminToken', token);
                    showAdminPanel();
                    loadMappings();
                    showToast('ç™»å½•æˆåŠŸ âœ“', 'success');
                } else {
                    showToast(data.error || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç®¡ç†é¢æ¿
        function showAdminPanel() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        // é€€å‡ºç™»å½•
        function logout() {
            adminToken = '';
            localStorage.removeItem('adminToken');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('tokenInput').value = '';
            selectedPrefixes.clear();
            updateBatchDeleteButton();
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        }

        // åŠ è½½æ‰€æœ‰æ˜ å°„
        async function loadMappings() {
            try {
                const response = await fetch('/api/mappings', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    allMappings = data.mappings || {};
                    updateStatsInfo(data.count, data.version);
                    renderMappings(allMappings);
                    selectedPrefixes.clear();
                    updateBatchDeleteButton();
                } else {
                    showToast(data.error || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatsInfo(count, version) {
            document.getElementById('statsInfo').textContent =
                `å…± ${count} ä¸ªæ˜ å°„ | ç‰ˆæœ¬ ${version}`;
        }

        // æ¸²æŸ“æ˜ å°„è¡¨æ ¼
        function renderMappings(mappings) {
            const tbody = document.getElementById('mappingsTable');

            if (Object.keys(mappings).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-16 text-center">
                            <div class="flex flex-col items-center">
                                <div class="text-5xl mb-3">ğŸ“­</div>
                                <div class="text-lg font-medium text-gray-600 mb-2">æš‚æ— APIæ˜ å°„</div>
                                <p class="text-sm text-gray-500">ç‚¹å‡»"åˆ›å»ºæ˜ å°„"æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæ˜ å°„</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedPrefixes = Object.keys(mappings).sort();

            tbody.innerHTML = sortedPrefixes.map(prefix => `
                <tr data-prefix="${prefix}" class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <input
                            type="checkbox"
                            class="mapping-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                            data-prefix="${prefix}"
                            onchange="handleCheckboxChange()"
                            ${selectedPrefixes.has(prefix) ? 'checked' : ''}
                        >
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 bg-blue-50 text-blue-700 rounded-md font-medium font-mono text-sm">
                            ${prefix}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-700 text-sm break-all">${mappings[prefix]}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-2">
                            <button onclick="editMapping('${prefix}')" class="px-3 py-1.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-md font-medium transition-colors text-sm">
                                ç¼–è¾‘
                            </button>
                            <button onclick="deleteMapping('${prefix}')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-md font-medium transition-colors text-sm">
                                åˆ é™¤
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // å¤„ç†å¤é€‰æ¡†å˜åŒ–
        function handleCheckboxChange() {
            selectedPrefixes.clear();
            document.querySelectorAll('.mapping-checkbox:checked').forEach(cb => {
                selectedPrefixes.add(cb.dataset.prefix);
            });
            updateBatchDeleteButton();
            updateSelectAllCheckbox();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.mapping-checkbox');

            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });

            handleCheckboxChange();
        }

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.mapping-checkbox');
            const checkedCount = document.querySelectorAll('.mapping-checkbox:checked').length;

            if (checkboxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®
        function updateBatchDeleteButton() {
            const btn = document.getElementById('batchDeleteBtn');
            const count = document.getElementById('selectedCount');

            if (selectedPrefixes.size > 0) {
                btn.classList.remove('hidden');
                count.textContent = selectedPrefixes.size;
            } else {
                btn.classList.add('hidden');
            }
        }

        // æ‰¹é‡åˆ é™¤
        async function batchDeleteMappings() {
            if (selectedPrefixes.size === 0) return;

            const prefixList = Array.from(selectedPrefixes).join('", "');
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹ ${selectedPrefixes.size} ä¸ªæ˜ å°„å—?\n\n"${prefixList}"\n\nè¿™å°†ç«‹å³ç”Ÿæ•ˆ,æ‰€æœ‰ä½¿ç”¨è¿™äº›å‰ç¼€çš„è¯·æ±‚å°†æ— æ³•ä»£ç†ã€‚`)) {
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const prefix of selectedPrefixes) {
                try {
                    const response = await fetch(`/api/mappings${prefix}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }

            if (successCount > 0) {
                showToast(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªæ˜ å°„${failCount > 0 ? `, ${failCount} ä¸ªå¤±è´¥` : ''}`, failCount > 0 ? 'warning' : 'success');
                loadMappings();
            } else {
                showToast('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // è¿‡æ»¤æ˜ å°„
        function filterMappings() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#mappingsTable tr[data-prefix]');

            rows.forEach(row => {
                const prefix = row.getAttribute('data-prefix');
                if (!prefix) return;

                const target = allMappings[prefix];
                const matches = prefix.toLowerCase().includes(searchTerm) ||
                               target.toLowerCase().includes(searchTerm);

                row.style.display = matches ? '' : 'none';
            });
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ APIæ˜ å°„';
            document.getElementById('prefixInput').value = '';
            document.getElementById('targetInput').value = '';
            document.getElementById('prefixInput').disabled = false;
            document.getElementById('mappingModal').classList.remove('hidden');
        }

        // ç¼–è¾‘æ˜ å°„
        function editMapping(prefix) {
            isEditMode = true;
            editingPrefix = prefix;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘APIæ˜ å°„';
            document.getElementById('prefixInput').value = prefix;
            document.getElementById('targetInput').value = allMappings[prefix];
            document.getElementById('prefixInput').disabled = true;
            document.getElementById('mappingModal').classList.remove('hidden');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('mappingModal').classList.add('hidden');
        }

        // å¤„ç†æ¨¡æ€æ¡†ç‚¹å‡»
        function handleModalClick(event) {
            if (event.target.id === 'mappingModal') {
                closeModal();
            }
        }

        // ä¿å­˜æ˜ å°„
        async function handleSaveMapping(event) {
            event.preventDefault();

            const prefix = document.getElementById('prefixInput').value.trim();
            const target = document.getElementById('targetInput').value.trim();

            try {
                let response;
                if (isEditMode) {
                    response = await fetch(`/api/mappings${editingPrefix}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ target })
                    });
                } else {
                    response = await fetch('/api/mappings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ prefix, target })
                    });
                }

                const data = await response.json();

                if (response.ok) {
                    showToast(isEditMode ? 'æ˜ å°„å·²æ›´æ–° âœ“' : 'æ˜ å°„å·²æ·»åŠ  âœ“', 'success');
                    closeModal();
                    loadMappings();
                } else {
                    showToast(data.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤æ˜ å°„
        async function deleteMapping(prefix) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ˜ å°„ "${prefix}" å—?\n\nè¿™å°†ç«‹å³ç”Ÿæ•ˆ,æ‰€æœ‰ä½¿ç”¨æ­¤å‰ç¼€çš„è¯·æ±‚å°†æ— æ³•ä»£ç†ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/mappings${prefix}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('æ˜ å°„å·²åˆ é™¤ âœ“', 'success');
                    loadMappings();
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºToast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-2xl text-white font-medium z-50 max-w-md show ${
                type === 'success' ? 'bg-emerald-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-amber-500'
            }`;

            setTimeout(() => {
                toast.className = toast.className.replace('show', 'hidden');
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                handleLogin({ preventDefault: () => {} });
            }
        });
    </script>
</body>
</html>
